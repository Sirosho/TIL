
# 📌 오라클 계층형 질의 (Hierarchical Query) 정리

## 1. 기본 개념

* **계층형 질의**: 트리 구조(조직도, 카테고리, 댓글 등)를 SQL에서 표현할 수 있는 오라클 전용 문법
* **START WITH**: 탐색 시작점(루트 또는 특정 노드)을 지정
* **CONNECT BY**: 계층적으로 연결되는 부모/자식 관계 정의
* **LEVEL**: START WITH로 지정한 노드부터 몇 단계 떨어져 있는지 나타냄 (상대적 깊이)

---
<div style="margin-top:80px;"></div>

## 2. 기본 문법

```sql
SELECT 컬럼들, LEVEL
FROM 테이블명
START WITH 조건(루트 또는 시작점)
CONNECT BY [NOCYCLE] PRIOR 부모컬럼 = 자식컬럼;
```

### 🔑 주요 키워드

* `START WITH`: 출발점(루트 노드 등)을 정의
* `CONNECT BY`: 부모-자식 연결 규칙을 정의
* `PRIOR`: 부모/자식 방향을 지정하는 핵심
* `LEVEL`: 현재 행이 출발점에서 몇 단계인지 표시
* `NOCYCLE`: 순환 참조(무한 루프) 방지

---

<div style="margin-top:80px;"></div>

## 순방향 탐색 (부모 → 자식)

```sql
SELECT LPAD(' ', LEVEL*2, ' ') || 부서명 AS 조직도,
       부서코드,
       상위부서코드,
       LEVEL AS LVL
FROM 부서
START WITH 부서코드 = 100
CONNECT BY PRIOR 부서코드 = 상위부서코드;
```


### 실행결과

| 조직도   | 부서코드 | 상위부서코드 | LVL |
| ----- | ---- | ------ | --- |
| 아시아지부 | 100  | NULL   | 1   |
| 일본지사  | 120  | 100    | 2   |
| 도쿄지점  | 121  | 120    | 3   |
| 오사카지점 | 122  | 120    | 3   |

---

<div style="margin-top:80px;"></div>

## 역방향 탐색 (자식 → 부모)

```sql
SELECT LPAD(' ', LEVEL*2, ' ') || 부서명 AS 조직도,
       부서코드,
       상위부서코드,
       LEVEL AS LVL
FROM 부서
START WITH 부서코드 = 121
CONNECT BY PRIOR 상위부서코드 = 부서코드;
```

### 실행결과
| 조직도   | 부서코드 | 상위부서코드 | LVL |
| ----- | ---- | ------ | --- |
| 도쿄지점  | 121  | 120    | 1   |
| 일본지사  | 120  | 100    | 2   |
| 아시아지부 | 100  | NULL   | 3   |





<div style="margin-top:80px;"></div>



## 3. 방향 규칙 (`PRIOR` 위치에 따라 달라짐)

| 유형      | 문법                             | 의미      | 탐색 방향  |
| ------- | ------------------------------ | ------- | ------ |
| **순방향** | `CONNECT BY PRIOR 자식컬럼 = 부모컬럼` | 부모 → 자식 | 위에서 아래 |
| **역방향** | `CONNECT BY PRIOR 부모컬럼 = 자식컬럼` | 자식 → 부모 | 아래에서 위 |

---

<div style="margin-top:80px;"></div>

## 4. 부모컬럼 vs 자식컬럼 구분 기준 

* **자식컬럼**

  * 중복 ❌
  * PK 성격 (예: 부서코드)
  * 각 행을 대표

* **부모컬럼**

  * 중복 ⭕ (여러 자식이 같은 부모 가리킴)
  * FK 성격 (예: 상위부서코드)
  * NULL 허용 (루트일 경우)

---


## 5. LEVEL의 의미

* `LEVEL`은 절대적 트리 깊이가 아니라, **START WITH 기준으로 카운팅되는 상대적 거리**

  * START WITH 노드 → LEVEL 1
  * 한 칸 이동할 때마다 +1


<div style="margin-top:80px;"></div>

* **“기준에서부터 한 칸씩 이동할 때마다 LEVEL +1”**
* **“자식컬럼은 중복 없고, 부모컬럼은 중복이 있다” → 이걸로 부모/자식 컬럼 구분 가능**
* **“PRIOR가 자식에 붙으면 순방향 트리, 부모에 붙으면 역방향 트리”**

---

<div style="margin-top:80px;"></div>

## 🎯 핵심 요약

* `START WITH`: 시작 노드
* `CONNECT BY`: 부모-자식 관계
* `PRIOR`: 방향 결정
* `LEVEL`: 시작점으로부터의 거리
* 부모컬럼: 중복 가능(FK), 자식컬럼: 중복 불가(PK)
